# This is the "Full Stack" Wazuh deployment.
# It runs its OWN Indexer and Dashboard, separated from your main OpenSearch.
# ⚠️ RESOURCE WARNING: This requires significantly more RAM (~4GB+).

services:
  # --- 1. Certificate Generator (Runs once to fix EISDIR errors) ---
  generate-certs:
    image: wazuh/wazuh-certs-tool:4.14.1
    command: >
      bash -c '
        if [ ! -f /certs/root-ca.pem ]; then
          /entrypoint.sh
          chmod -R 777 /certs
        else
          echo "Certificates already exist. Skipping generation."
        fi
      '
    volumes:
      - wazuh_certs:/certs
    networks:
      - dokploy-network

  # --- 2. Wazuh Indexer (The Database) ---
  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.14.1
    restart: always
    ports:
      - "9200" # Internal Dokploy port
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "network.host=0.0.0.0"
      - "node.name=wazuh.indexer"
      - "cluster.initial_cluster_manager_nodes=wazuh.indexer"
      - "plugins.security.ssl.http.pemcert_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.http.pemkey_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.http.pemtrustedcas_filepath=/usr/share/wazuh-indexer/config/certs/root-ca.pem"
      - "plugins.security.ssl.transport.pemcert_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.transport.pemkey_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.transport.pemtrustedcas_filepath=/usr/share/wazuh-indexer/config/certs/root-ca.pem"
      - "plugins.security.allow_default_init_securityindex=true"
      # Passwords managed by Dokploy UI
      - "WAZUH_INDEXER_USERNAME=admin"
      - "WAZUH_INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}" 
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh_indexer_data:/var/lib/wazuh-indexer
      - wazuh_certs:/usr/share/wazuh-indexer/config/certs # Uses generated certs
    networks:
      - dokploy-network
    depends_on:
      - generate-certs

  # --- 3. Wazuh Manager (The Server) ---
  wazuh.manager:
    image: wazuh/wazuh-manager:4.14.1
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514"       # Agent connection (Public)
      - "1515:1515"       # Agent enrollment (Public)
      - "514:514/udp"     # Syslog (Public)
    expose:
      - "55000"           # API port (Internal/Proxy)
    environment:
      # Connects to the dedicated wazuh.indexer service
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=none
      - API_USERNAME=${WAZUH_API_USER}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
    networks:
      - dokploy-network
    depends_on:
      - wazuh.indexer

  # --- 4. Wazuh Dashboard (The UI) ---
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.14.1
    restart: always
    expose:
      - "5601" # UI Port
    environment:
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - WAZUH_API_URL=https://wazuh.manager
      - API_USERNAME=${WAZUH_API_USER}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - wazuh_dashboard_config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh_certs:/usr/share/wazuh-dashboard/certs # Uses generated certs
    networks:
      - dokploy-network
    depends_on:
      - wazuh.indexer
      - wazuh.manager

volumes:
  wazuh_certs: # Shared volume for certificates
  wazuh_indexer_data:
  wazuh_dashboard_config:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_active_response:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:

networks:
  dokploy-network:
    external: true
