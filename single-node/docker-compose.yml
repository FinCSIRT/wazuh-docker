services:
  # --- 1. Certificate Generator (Alpine Replacement) ---
  # Replaces the missing 'wazuh-certs-tool'.
  # Uses OpenSSL to generate self-signed certs for the cluster.
  generate-certs:
    image: alpine:latest
    restart: on-failure
    command: >
      sh -c '
        if [ ! -f /certs/root-ca.pem ]; then
          apk update && apk add openssl
          mkdir -p /certs
          cd /certs

          echo "Generating Root CA..."
          openssl req -x509 -newkey rsa:2048 -keyout root-ca.key -out root-ca.pem -days 3650 -nodes -subj "/C=US/L=California/O=Wazuh/CN=root-ca"

          echo "Generating Admin Cert..."
          openssl req -newkey rsa:2048 -keyout admin-key.pem -out admin.csr -nodes -subj "/C=US/L=California/O=Wazuh/CN=admin"
          openssl x509 -req -in admin.csr -CA root-ca.pem -CAkey root-ca.key -CAcreateserial -out admin.pem -days 3650

          echo "Generating Indexer Cert..."
          openssl req -newkey rsa:2048 -keyout wazuh.indexer-key.pem -out wazuh.indexer.csr -nodes -subj "/C=US/L=California/O=Wazuh/CN=wazuh.indexer"
          openssl x509 -req -in wazuh.indexer.csr -CA root-ca.pem -CAkey root-ca.key -CAcreateserial -out wazuh.indexer.pem -days 3650

          echo "Generating Manager Cert..."
          openssl req -newkey rsa:2048 -keyout wazuh.manager-key.pem -out wazuh.manager.csr -nodes -subj "/C=US/L=California/O=Wazuh/CN=wazuh.manager"
          openssl x509 -req -in wazuh.manager.csr -CA root-ca.pem -CAkey root-ca.key -CAcreateserial -out wazuh.manager.pem -days 3650

          echo "Generating Dashboard Cert..."
          openssl req -newkey rsa:2048 -keyout wazuh.dashboard-key.pem -out wazuh.dashboard.csr -nodes -subj "/C=US/L=California/O=Wazuh/CN=wazuh.dashboard"
          openssl x509 -req -in wazuh.dashboard.csr -CA root-ca.pem -CAkey root-ca.key -CAcreateserial -out wazuh.dashboard.pem -days 3650

          chmod -R 777 /certs
          echo "Certificates generated successfully."
        else
          echo "Certificates already exist. Skipping generation."
        fi
      '
    volumes:
      - wazuh_certs:/certs
    networks:
      - dokploy-network

  # --- 2. Wazuh Indexer (The Database) ---
  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.9.2
    restart: always
    ports:
      - "9200" # Internal Dokploy port
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "network.host=0.0.0.0"
      - "node.name=wazuh.indexer"
      - "cluster.initial_cluster_manager_nodes=wazuh.indexer"
      # SSL Configuration using the volume
      - "plugins.security.ssl.http.pemcert_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.http.pemkey_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.http.pemtrustedcas_filepath=/usr/share/wazuh-indexer/config/certs/root-ca.pem"
      - "plugins.security.ssl.transport.pemcert_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.transport.pemkey_filepath=/usr/share/wazuh-indexer/config/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.transport.pemtrustedcas_filepath=/usr/share/wazuh-indexer/config/certs/root-ca.pem"
      - "plugins.security.allow_default_init_securityindex=true"
      # Passwords managed by Dokploy UI
      - "WAZUH_INDEXER_USERNAME=admin"
      - "WAZUH_INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}" 
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh_indexer_data:/var/lib/wazuh-indexer
      - wazuh_certs:/usr/share/wazuh-indexer/config/certs # Uses generated certs
    networks:
      - dokploy-network
    depends_on:
      - generate-certs

  # --- 3. Wazuh Manager (The Server) ---
  wazuh.manager:
    image: wazuh/wazuh-manager:4.9.2
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      # Agent ports must be PUBLIC (Host Mode)
      - "1514:1514"       # Agent connection
      - "1515:1515"       # Agent enrollment
      - "514:514/udp"     # Syslog
    expose:
      - "55000"           # API port (Internal for Dokploy proxy)
    environment:
      # Connects to the dedicated wazuh.indexer service
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=none
      - API_USERNAME=${WAZUH_API_USER}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
      # Certs from volume
      - wazuh_certs:/etc/filebeat/certs
      - ./config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
    networks:
      - dokploy-network
    depends_on:
      - wazuh.indexer

  # --- 4. Wazuh Dashboard (The UI) ---
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.9.2
    restart: always
    expose:
      - "5601" # UI Port (Internal for Dokploy proxy)
    environment:
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - WAZUH_API_URL=https://wazuh.manager
      - API_USERNAME=${WAZUH_API_USER}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - wazuh_dashboard_config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh_certs:/usr/share/wazuh-dashboard/certs # Uses generated certs
    networks:
      - dokploy-network
    depends_on:
      - wazuh.indexer
      - wazuh.manager

volumes:
  wazuh_certs: # Shared volume for certificates
  wazuh_indexer_data:
  wazuh_dashboard_config:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_active_response:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:

networks:
  dokploy-network:
    external: true
